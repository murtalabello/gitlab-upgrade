- name: Upgrade GitLab to version {{ target_version }}
  hosts: gitlab
  become: true

  tasks:
    - name: Copy version_check.sh to the target server
      copy:
        src: version_check.sh
        dest: /tmp/version_check.sh
        mode: '0755'

    - name: Check GitLab version compatibility
      shell: /tmp/version_check.sh
      register: version_check_result
      failed_when: "'Direct upgrade from' not in version_check_result.stdout"
      changed_when: false

    - name: Ensure GitLab repository is configured
      yum_repository:
        name: gitlab_gitlab-ee
        description: GitLab EE Repository
        baseurl: https://packages.gitlab.com/gitlab/gitlab-ee/el/8/$basearch
        gpgcheck: yes
        enabled: yes
        repo_gpgcheck: yes
        gpgkey: https://packages.gitlab.com/gitlab/gitlab-ee/gpgkey

    - name: Ensure GitLab is updated to version {{ target_version }}
      yum:
        name: gitlab-ee-{{ target_version }}.*
        state: latest

    - name: Reconfigure GitLab
      command: /opt/gitlab/bin/gitlab-ctl reconfigure

    - name: Restart GitLab
      command: /opt/gitlab/bin/gitlab-ctl restart

    - name: Verify GitLab Version
      shell: /opt/gitlab/bin/gitlab-rake gitlab:env:info | grep "Version:"
      register: gitlab_version
      changed_when: false
      ignore_errors: true

    - name: Display GitLab Version
      debug:
        msg: "{{ gitlab_version.stdout }}"
      when: gitlab_version is defined and gitlab_version.stdout is defined
