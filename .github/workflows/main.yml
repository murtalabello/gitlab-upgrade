- name: Upgrade GitLab to version 17.3
  hosts: gitlab
  become: true

  tasks:
    - name: Check GitLab version compatibility
      shell: /tmp/version_check.sh
      register: version_check_result
      failed_when: "'Direct upgrade from' not in version_check_result.stdout"
      changed_when: false

    - name: Ensure GitLab repository is configured
      yum_repository:
        name: gitlab_gitlab-ee
        description: GitLab EE Repository
        baseurl: https://packages.gitlab.com/gitlab/gitlab-ee/el/8/$basearch
        gpgcheck: yes
        enabled: yes
        repo_gpgcheck: yes
        gpgkey: https://packages.gitlab.com/gitlab/gitlab-ee/gpgkey

    - name: Ensure GitLab is updated to target version
      yum:
        name: "gitlab-ee-{{ target_version }}.*"
        state: latest

    - name: Reconfigure GitLab
      command: /opt/gitlab/bin/gitlab-ctl reconfigure

    - name: Restart GitLab
      command: /opt/gitlab/bin/gitlab-ctl restart

    - name: Verify GitLab Version
      shell: /opt/gitlab/bin/gitlab-rake gitlab:env:info | grep "Version:"
      register: gitlab_version
      changed_when: false
